{% extends "base.html" %}

{% block title %}Configure Display - Digital Signage{% endblock %}

{% block body %}
<div class="config-container">
    <!-- Sticky Header -->
    <header class="config-header">
        <div class="config-header-left">
            <a href="/displays" class="btn btn-secondary btn-sm" title="Back to Displays">
                <i class="material-icons">arrow_back</i>
            </a>
            <div class="config-header-title">
                <span class="config-header-label">Configure</span>
                <input type="text" id="displayName" value="{{ display[1] }}" class="config-title-input" spellcheck="false">
            </div>
        </div>
        <div class="config-header-right">
            <button type="button" class="btn btn-secondary btn-sm" id="previewToggleBtn" onclick="togglePreview()">
                <i class="material-icons">visibility</i>
                Preview
            </button>
            <a href="/player/{{ display[0] }}" class="btn btn-secondary btn-sm" target="_blank">
                <i class="material-icons">open_in_new</i>
                Open Player
            </a>
            <button type="button" class="btn btn-primary btn-sm" id="saveBtn" onclick="saveConfig()">
                <i class="material-icons">save</i>
                Save Changes
            </button>
        </div>
    </header>

    <!-- Main Body: Center + Panel -->
    <div class="config-body">
        <!-- Center: Toolbar + Grid -->
        <div class="config-center">
            <div class="grid-toolbar">
                <div class="toolbar-group">
                    <label class="toolbar-label">Grid</label>
                    <select id="gridRows" class="toolbar-select">
                        <option value="1">1 row</option>
                        <option value="2">2 rows</option>
                        <option value="3">3 rows</option>
                        <option value="4">4 rows</option>
                    </select>
                    <span class="toolbar-x">&times;</span>
                    <select id="gridCols" class="toolbar-select">
                        <option value="1">1 col</option>
                        <option value="2">2 cols</option>
                        <option value="3">3 cols</option>
                        <option value="4">4 cols</option>
                    </select>
                </div>
                <div class="toolbar-group">
                    <button type="button" id="mergeToggleBtn" class="btn btn-secondary btn-sm" onclick="toggleMergeMode()">
                        <i class="material-icons">merge_type</i>
                        Merge
                    </button>
                    <button type="button" id="mergeApplyBtn" class="btn btn-primary btn-sm" onclick="applyMerge()" style="display:none;">
                        <i class="material-icons">check</i>
                        Apply Merge
                    </button>
                    <button type="button" id="mergeCancelBtn" class="btn btn-secondary btn-sm" onclick="toggleMergeMode()" style="display:none;">
                        Cancel
                    </button>
                    <span id="mergeHint" class="toolbar-hint" style="display:none;">Click zones to select, then apply merge</span>
                </div>
            </div>

            <div class="grid-canvas" id="gridPreview">
                <!-- Zones rendered by JS -->
            </div>
        </div>

        <!-- Right Panel -->
        <div class="config-panel">
            <div id="panelContent">
                <!-- Filled dynamically by renderPanel() -->
            </div>
        </div>
    </div>

    <!-- Preview Slide-out -->
    <div class="preview-slideout" id="previewSlideout">
        <div class="preview-slideout-header">
            <span>Live Preview</span>
            <div>
                <button type="button" class="btn btn-secondary btn-sm" onclick="refreshPreview()" title="Refresh">
                    <i class="material-icons">refresh</i>
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="togglePreview()" title="Close">
                    <i class="material-icons">close</i>
                </button>
            </div>
        </div>
        <div class="preview-slideout-body">
            <iframe id="livePreview" src="/player/{{ display[0] }}?preview=1"></iframe>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/config.js') }}"></script>
<script>
const displayId = {{ display[0] }};
const layoutConfig = {{ display[3]|safe }};
const backgroundConfig = {{ display[4]|safe }};
const displayDescription = {{ (display[2] or '')|tojson }};

window.addEventListener('DOMContentLoaded', function() {
    initConfigPage(displayId, layoutConfig, backgroundConfig, displayDescription);
});
</script>
{% endblock %}
